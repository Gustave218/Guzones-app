{% extends "base.html" %}
{% set hide_footer = True %}

{% block content %}

<h2 class="mb-4">
  {{ category.name_fr if g.lang == 'fr' else category.name_en }}
</h2>

<!-- âœ… GRID FIX: 2 cols mobile, 3 tablet, 4 desktop -->
<div class="row g-3 category-products-grid" id="productsGrid">

  {% for product in products %}
  {% set rating = (product.id % 3) + 3 %}
  {% set reviews = (product.id * 13) % 240 + 12 %}

  <div class="col-6 col-md-4 col-lg-3 product-item">

    <div class="card h-100 shadow-sm product-card border-0 position-relative">

      <!-- â¤ï¸ WISHLIST -->
      <span class="wishlist-btn">â™¡</span>

      <!-- CLICKABLE CARD -->
      <a href="{{ url_for('product_detail', product_id=product.id) }}"
         class="text-decoration-none text-dark">

        <!-- IMAGE + BADGES -->
        <div class="position-relative">

          {% if product.is_new %}
            <span class="product-badge badge-new">{{ t.new }}</span>
          {% elif product.is_trending %}
            <span class="product-badge badge-trending">{{ t.trending }}</span>
          {% elif product.is_featured %}
            <span class="product-badge badge-featured">{{ t.featured }}</span>
          {% elif product.is_on_sale %}
            <span class="product-badge badge-sale">{{ t.on_sale }}</span>
          {% endif %}

          {% if product.images %}
            <img src="{{ product.images[0].image | smart_img }}"
                 class="card-img-top"
                 style="height:180px; object-fit:cover;">
          {% else %}
            <img src="{{ 'images/placeholder.png' | smart_img }}"
                 class="card-img-top"
                 style="height:180px; object-fit:cover;">
          {% endif %}
        </div>

        <!-- PRODUCT INFO -->
        <div class="card-body p-2">

          <!-- â­ REVIEWS -->
          <div class="rating mb-1">
            {% for i in range(rating) %}â˜…{% endfor %}
            {% for i in range(5-rating) %}â˜†{% endfor %}
            <span>({{ reviews }})</span>
          </div>

          <h6 class="fw-semibold mb-1 product-title">
            {{ product.name_fr if g.lang == 'fr' else product.name_en }}
          </h6>

          <p class="fw-bold text-dark mb-0">
            {{ product | money }}
          </p>
        </div>

      </a>

      <!-- ADD TO CART -->
      <div class="px-2 pb-3">
        <a href="{{ url_for('add_to_cart', product_id=product.id) }}"
           class="btn btn-dark w-100 rounded-pill btn-sm">
          ðŸ›’ {{ t.add_to_cart }}
        </a>
      </div>

    </div>

  </div>
  {% endfor %}

</div>

<!-- ðŸ”„ LOADING -->
<div id="loading" class="text-center my-4" style="display:none;">
  <div class="spinner-border"></div>
</div>

<!-- â™¾ï¸ INFINITE SCROLL (LOOP MODE) -->
<script>
let page = 1;
let loading = false;

window.addEventListener("scroll", () => {
  if (loading) return;

  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) {
    loadMore();
  }
});

function loadMore() {
  loading = true;
  page++;
  document.getElementById("loading").style.display = "block";

  fetch(window.location.pathname + "?page=" + page, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
  .then(res => res.text())
  .then(html => {
    if (!html.trim()) {
      page = 1; // ðŸ” restart SAME category
      loading = false;
      document.getElementById("loading").style.display = "none";
      return;
    }

    const temp = document.createElement("div");
    temp.innerHTML = html;

    temp.querySelectorAll(".product-item").forEach(item => {
      document.getElementById("productsGrid").appendChild(item);
    });

    loading = false;
    document.getElementById("loading").style.display = "none";
  })
  .catch(() => {
    loading = false;
    document.getElementById("loading").style.display = "none";
  });
}
</script>

{% endblock %}