{% extends "base.html" %}
{% block content %}

<h2>Add New Product</h2>

<form action="{{ url_for('add_product') }}"
      method="POST"
      enctype="multipart/form-data"
      class="p-4 bg-light rounded shadow-sm"
      id="productForm">

    <div class="mb-3">
        <label class="form-label">Name (EN)</label>
        <input type="text" name="name_en" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Name (FR)</label>
        <input type="text" name="name_fr" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Description (EN)</label>
        <textarea name="description_en" class="form-control"></textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">Description (FR)</label>
        <textarea name="description_fr" class="form-control"></textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">Price</label>
        <input type="number" name="price" class="form-control" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Category</label>
        <select name="category_id" class="form-select" required>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name_en }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Shop / Company Name</label>
        <input type="text" name="shop_name" class="form-control">
    </div>

    <div class="mb-3">
        <label class="form-label">Shop Location</label>
        <input type="text" name="shop_location" class="form-control">
    </div>

    <div class="mb-3">
        <label>Product Images</label>
        <input type="file" id="imagesInput" multiple class="form-control">

        <input type="hidden" name="cloud_images" id="cloudImages">

        <div id="previewBox" class="d-flex flex-wrap gap-2 mt-2"></div>
    </div>

    <button type="submit" class="btn btn-success w-100" id="submitBtn">
        Add Product
    </button>

    <div class="row mt-3">
        <div class="col-md-3 form-check">
            <input type="checkbox" class="form-check-input" name="is_new">
            <label class="form-check-label">New Arrival</label>
        </div>
        <div class="col-md-3 form-check">
            <input type="checkbox" class="form-check-input" name="is_trending">
            <label class="form-check-label">Trending</label>
        </div>
        <div class="col-md-3 form-check">
            <input type="checkbox" class="form-check-input" name="is_featured">
            <label class="form-check-label">Featured</label>
        </div>
        <div class="col-md-3 form-check">
            <input type="checkbox" class="form-check-input" name="is_on_sale">
            <label class="form-check-label">On Sale</label>
        </div>
    </div>

    <label class="form-label mt-3">Currency</label>
    <select name="currency" class="form-select">
        <option value="USD" selected>USD</option>
        <option value="KES">KES</option>
        <option value="CDF">CDF</option>
        <option value="EUR">EUR</option>
        <option value="TZS">TZS</option>
        <option value="UGX">UGX</option>
    </select>
</form>

<div class="progress mt-3" style="height:18px; display:none;" id="uploadProgressBox">
  <div class="progress-bar progress-bar-striped progress-bar-animated"
       role="progressbar"
       style="width:0%" id="uploadProgress">
    0%
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const CLOUD_NAME = "dxvtxotqh";
    const UPLOAD_PRESET = "guzones_unsigned";

    const input = document.getElementById("imagesInput");
    const previewBox = document.getElementById("previewBox");
    const cloudInput = document.getElementById("cloudImages");
    const progressBox = document.getElementById("uploadProgressBox");
    const progressBar = document.getElementById("uploadProgress");
    const btn = document.getElementById("submitBtn");

    let uploadedUrls = [];

    input.addEventListener("change", async () => {
        previewBox.innerHTML = "";
        uploadedUrls = [];

        progressBox.style.display = "block";
        progressBar.style.width = "0%";

        const files = Array.from(input.files);
        let done = 0;

        for (const file of files) {

            const wrapper = document.createElement("div");
            wrapper.style.position = "relative";
            wrapper.innerText = "Uploading...";
            previewBox.appendChild(wrapper);

            const fd = new FormData();
            fd.append("file", file);
            fd.append("upload_preset", UPLOAD_PRESET);

            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: "POST",
                body: fd
            });

            const data = await res.json();

            if (!data.secure_url) {
                wrapper.innerText = "❌ Failed";
                continue;
            }

            uploadedUrls.push(data.secure_url);
            cloudInput.value = JSON.stringify(uploadedUrls);

            done++;
            progressBar.style.width = (done / files.length * 100) + "%";

            wrapper.innerHTML = `
                <img src="${data.secure_url}" style="width:80px;height:80px;object-fit:cover;border-radius:6px">
                <button type="button" style="position:absolute;top:-6px;right:-6px;background:red;color:white;border:none;border-radius:50%;width:20px;height:20px;">×</button>
            `;

            wrapper.querySelector("button").onclick = () => {
                uploadedUrls = uploadedUrls.filter(u => u !== data.secure_url);
                cloudInput.value = JSON.stringify(uploadedUrls);
                wrapper.remove();
            };
        }
    });

    document.getElementById("productForm").addEventListener("submit", () => {
        btn.disabled = true;
        btn.innerText = "Saving product… ⏳";
    });

});
</script>

{% endblock %}